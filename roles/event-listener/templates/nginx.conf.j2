load_module modules/ngx_http_geoip_module.so;

#user  nobody;
worker_processes  5;

error_log  /var/nginx/logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

pid        /var/nginx/logs/nginx.pid;


events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    server_tokens off;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$host" "$request" '
                      '$status $body_bytes_sent "$request_body" "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$http_x_real_ip" "$http_content_type"';

    #access_log  /var/nginx/logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    gzip on;
    gzip_vary on;
    gzip_types    text/plain application/javascript application/x-javascript text/javascript text/xml text/css text/html application/json application/json;
    gzip_http_version 1.0;
    gzip_proxied any;

    geoip_country      	/etc/nginx/geoip/GeoIP.dat;
    geoip_city 		/etc/nginx/geoip/GeoLiteCity.dat;

    geo $auth_bypass {
        172.16.0.0/16 "off"; #aws internal
        192.168.0.0/16 "off"; #lan internal
        60.251.49.197/32 "off"; #office
        60.251.49.198/32 "off"; #office
        52.68.143.245/32 "off"; #demo vpn
        52.198.226.239/32 "off"; #prod vpn
        default "Restricted";
    }

    real_ip_header X-Forwarded-For;
    real_ip_recursive on;
    set_real_ip_from 172.16.0.0/16;
    set_real_ip_from 13.113.52.220/32; # proxy
    set_real_ip_from 13.113.62.13/32; # proxy
    set_real_ip_from 13.113.51.227/32; # proxy

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        access_log  /var/nginx/logs/host.access.log    	main;

        location /api-docs/ui {
            proxy_pass              http://{{service_name}}:{{service_port}};
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Host            $http_host;

            proxy_set_header   X-GeoIp-City-Country-Code $geoip_city_country_code;
            proxy_set_header   X-GeoIp-City-Country-Code3 $geoip_city_country_code3;
            proxy_set_header   X-GeoIp-City-Country-Name $geoip_city_country_name;
            proxy_set_header   X-GeoIp-Region $geoip_region;
            proxy_set_header   X-GeoIp-Region-Name $geoip_region_name;
            proxy_set_header   X-GeoIp-City $geoip_city;
            proxy_set_header   X-GeoIp-Postal-Code $geoip_postal_code;
            proxy_set_header   X-GeoIp-City-Continent-Code $geoip_city_continent_code;
            proxy_set_header   X-GeoIp-Latitude $geoip_latitude;
            proxy_set_header   X-GeoIp-Longitude $geoip_longitude;
            proxy_set_header   X-GeoIp-DMA-code $geoip_dma_code;
            proxy_set_header   X-GeoIp-Area-Code $geoip_area_code;

            expires off;
            auth_basic              $auth_bypass;
            auth_basic_user_file    /etc/nginx/.htpasswd;
        }

        location / {
            proxy_pass              http://{{service_name}}:{{service_port}};
            proxy_set_header        X-Real-IP       $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Host            $http_host;

            proxy_set_header   X-GeoIp-City-Country-Code $geoip_city_country_code;
            proxy_set_header   X-GeoIp-City-Country-Code3 $geoip_city_country_code3;
            proxy_set_header   X-GeoIp-City-Country-Name $geoip_city_country_name;
            proxy_set_header   X-GeoIp-Region $geoip_region;
            proxy_set_header   X-GeoIp-Region-Name $geoip_region_name;
            proxy_set_header   X-GeoIp-City $geoip_city;
            proxy_set_header   X-GeoIp-Postal-Code $geoip_postal_code;
            proxy_set_header   X-GeoIp-City-Continent-Code $geoip_city_continent_code;
            proxy_set_header   X-GeoIp-Latitude $geoip_latitude;
            proxy_set_header   X-GeoIp-Longitude $geoip_longitude;
            proxy_set_header   X-GeoIp-DMA-code $geoip_dma_code;
            proxy_set_header   X-GeoIp-Area-Code $geoip_area_code;

            expires off;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;

    }

}